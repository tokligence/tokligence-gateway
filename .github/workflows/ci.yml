name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  # Job 1: Backend Go Tests
  backend-tests:
    name: Backend Tests (Go 1.24)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache: true

      - name: Download dependencies
        run: go mod download

      - name: Run Go tests
        run: make be-test
        env:
          # Clear any inherited environment variables that might affect tests
          TOKLIGENCE_MARKETPLACE_ENABLED: ""
          TOKLIGENCE_AUTH_SECRET: ""
          TOKLIGENCE_LOG_LEVEL: ""

      - name: Generate coverage report
        run: go test -coverprofile=coverage.out ./...
        env:
          # Clear environment variables for coverage generation too
          TOKLIGENCE_MARKETPLACE_ENABLED: ""

      - name: Check coverage threshold (91%)
        run: |
          coverage=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | sed 's/%//')
          if (( $(echo "$coverage < 91" | bc -l) )); then
            echo "Coverage $coverage% is below 91% threshold"
            exit 1
          fi

      - name: Upload coverage to artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage.out

  # Job 2: Frontend Tests
  frontend-tests:
    name: Frontend Tests (Node.js 18)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: fe/package-lock.json

      - name: Install dependencies
        working-directory: fe
        run: npm ci

      - name: Run ESLint
        working-directory: fe
        run: npm run lint

      - name: Run Frontend Tests
        working-directory: fe
        run: npm run test

  # Job 3: Build Verification
  build-check:
    name: Build Verification
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache: true

      - name: Build gateway CLI
        run: make build-gateway

      - name: Build gatewayd daemon
        run: make build-gatewayd

      - name: Verify binaries exist
        run: |
          test -f bin/gateway || exit 1
          test -f bin/gatewayd || exit 1
          echo "✅ Gateway CLI built successfully"
          echo "✅ Gatewayd daemon built successfully"
