# Tokligence Gateway v0.3.4

Date: 2025-11-20

This release focuses on database performance, scalability, and resource management with comprehensive PostgreSQL support and async ledger batch writing.

## Highlights

### Database & Performance Improvements

- **PostgreSQL Ledger Support**
  - Full PostgreSQL integration for ledger and identity storage
  - Auto-detection via DSN format (`postgresql://...`)
  - 9.6x throughput improvement over comparable solutions (11,227 RPS peak)
  - Connection pooling for high concurrency (1000+ QPS support)

- **Async Ledger Batch Writer**
  - Non-blocking database writes eliminate HTTP response path blocking
  - Configurable batching (100-10,000 entries per batch)
  - Multi-worker parallel processing (1-50 workers)
  - Reduces P99 latency from 5+ seconds to milliseconds
  - Buffer sizing for burst traffic (10K-1M entries)

- **Database Connection Pool Management**
  - Fixes file descriptor leak (14k+ open FDs under load)
  - Configurable pool limits (max open/idle connections)
  - Connection lifetime and idle timeout controls
  - Prevents resource exhaustion under high concurrency

### Configuration

New environment variables:

**Database Backend:**
- `TOKLIGENCE_LEDGER_PATH` - Now supports PostgreSQL DSN (e.g., `postgresql://user:pass@host:5432/db`)
- `TOKLIGENCE_IDENTITY_PATH` - PostgreSQL support for identity store

**Connection Pool:**
- `TOKLIGENCE_DB_MAX_OPEN_CONNS` (default: 1000)
- `TOKLIGENCE_DB_MAX_IDLE_CONNS` (default: 100)
- `TOKLIGENCE_DB_CONN_MAX_LIFETIME` (default: 60 minutes)
- `TOKLIGENCE_DB_CONN_MAX_IDLE_TIME` (default: 10 minutes)

**Async Ledger:**
- `TOKLIGENCE_LEDGER_ASYNC_BATCH_SIZE` (default: 100)
- `TOKLIGENCE_LEDGER_ASYNC_FLUSH_MS` (default: 1000)
- `TOKLIGENCE_LEDGER_ASYNC_BUFFER_SIZE` (default: 10000)
- `TOKLIGENCE_LEDGER_ASYNC_NUM_WORKERS` (default: 1)

### Documentation

- **New**: `docs/async-ledger-tuning.md` - Comprehensive tuning guide for 100 QPS to 1M+ QPS
- **New**: `scripts/benchmark/performance-comparison-sqlite-vs-postgresql.md` - Detailed benchmark results
- **Updated**: `docs/configuration_guide.md` - PostgreSQL setup and async ledger configuration
- **Updated**: `README.md` and `README_zh.md` - PostgreSQL features and async ledger

## Performance Benchmarks

Test environment: 4 vCPUs, 8GB RAM (GCP e2-custom-4-8192)

**Peak Performance:**
- **11,227 RPS** average (9.6x faster than LiteLLM @ 1,170 RPS)
- **12,908 RPS** peak @ 100 concurrent connections
- **Sub-10ms P50 latency** maintained across all concurrency levels
- **19.2x better cost efficiency** per RPS

**Optimizations tested:**
- 5,000 batch size, 200ms flush interval
- 500K buffer, 20 workers
- PostgreSQL with connection pooling

## Tuning Guidelines

| QPS Range | Batch Size | Flush (ms) | Buffer Size | Workers |
|-----------|------------|------------|-------------|---------|
| < 100     | 50         | 2000       | 5,000       | 1       |
| 100-1K    | 100        | 1000       | 10,000      | 2       |
| 1K-10K    | 500        | 500        | 50,000      | 5       |
| 10K-100K  | 2,000      | 200        | 200,000     | 10      |
| 100K-1M   | 10,000     | 100        | 1,000,000   | 50      |

## Upgrade Notes

1. **SQLite users**: No changes required. All existing SQLite databases work as before.

2. **PostgreSQL migration** (optional):
   ```bash
   # Create PostgreSQL databases
   createdb tokligence_ledger
   createdb tokligence_identity

   # Update configuration
   export TOKLIGENCE_LEDGER_PATH="postgresql://user:pass@localhost:5432/tokligence_ledger"
   export TOKLIGENCE_IDENTITY_PATH="postgresql://user:pass@localhost:5432/tokligence_identity"

   # Tables are created automatically on startup
   ```

3. **High-traffic deployments**: Enable async ledger for 1K+ QPS
   ```bash
   # For 50K QPS
   export TOKLIGENCE_LEDGER_ASYNC_BATCH_SIZE=5000
   export TOKLIGENCE_LEDGER_ASYNC_FLUSH_MS=200
   export TOKLIGENCE_LEDGER_ASYNC_BUFFER_SIZE=500000
   export TOKLIGENCE_LEDGER_ASYNC_NUM_WORKERS=20
   ```

4. **Connection pool tuning**: Adjust based on your database backend
   ```bash
   # PostgreSQL (high concurrency)
   export TOKLIGENCE_DB_MAX_OPEN_CONNS=1000
   export TOKLIGENCE_DB_MAX_IDLE_CONNS=100
   ```

## Bug Fixes

- Fix database connection pool resource leak (14k+ open file descriptors)
- Handle NULL display_name in PostgreSQL userstore
- Pass connection pool parameters to userstore initialization

## Trade-offs

**Async Ledger:**
- **Memory usage**: Buffer size Ã— entry size (~1-2KB) memory overhead
- **Data loss risk**: On crash, up to `buffer_size` entries may be lost (graceful shutdown flushes all)
- **Write latency**: Entries written within `flush_ms` interval (not real-time)

**Mitigation:**
- Use systemd/supervisor for auto-restart
- Enable PostgreSQL replication for database durability
- For critical billing data, consider synchronous writes or external audit log

## Testing

- Comprehensive load testing with 10-100 concurrent connections
- Verified connection pool limits prevent FD leaks
- PostgreSQL ledger tested under 11K+ RPS sustained load
- Async ledger graceful shutdown tested
- NULL display_name handling verified in PostgreSQL

## Files Changed

**Core Implementation:**
- `internal/ledger/async/async.go` - Async batch writer with multi-worker support
- `internal/ledger/postgres/postgres.go` - PostgreSQL ledger implementation
- `internal/ledger/sqlite/sqlite.go` - Connection pool limits
- `internal/userstore/postgres/postgres.go` - Connection pool config, NULL handling
- `internal/userstore/sqlite/sqlite.go` - Connection pool limits
- `cmd/gateway/main.go` - Async ledger initialization
- `cmd/gatewayd/main.go` - Database backend detection and setup

**Configuration:**
- `config/setting.ini` - Async ledger and connection pool defaults
- `internal/config/config.go` - New config parameters

**Documentation:**
- `docs/async-ledger-tuning.md` - Comprehensive tuning guide (NEW)
- `docs/configuration_guide.md` - PostgreSQL and async ledger sections
- `scripts/benchmark/performance-comparison-sqlite-vs-postgresql.md` - Benchmark results (NEW)
- `README.md`, `README_zh.md` - Feature updates

**Tools:**
- `scripts/benchmark/loadtest.go` - Connection pool optimization, percentile metrics
- `monitor_resources.sh` - Resource monitoring script

## Contributors

This release includes contributions focused on performance optimization and scalability improvements for production deployments.

## Next Steps

For detailed tuning guidance:
- See `docs/async-ledger-tuning.md` for parameter optimization
- See `scripts/benchmark/performance-comparison-sqlite-vs-postgresql.md` for benchmark methodology
- See `docs/configuration_guide.md` for complete configuration reference
