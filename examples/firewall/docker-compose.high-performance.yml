# High-Performance Deployment with Load Balancing
# This setup provides ~2000+ req/s throughput
# Default NER engine: XLM-RoBERTa (best multilingual accuracy)
#
# Usage:
#   docker-compose -f docker-compose.high-performance.yml up -d

version: '3.8'

services:
  # Tokligence Gateway
  gateway:
    build: ../../..  # Root directory
    container_name: tokligence-gateway
    ports:
      - "8081:8081"
    volumes:
      - ../../../config:/app/config
      - ../../../logs:/app/logs
    environment:
      - TOKLIGENCE_LOG_LEVEL=info
      - TOKLIGENCE_PROMPT_FIREWALL_ENABLED=true
      - TOKLIGENCE_PROMPT_FIREWALL_MODE=redact
    depends_on:
      - presidio-lb
    restart: unless-stopped
    networks:
      - firewall-net

  # Nginx Load Balancer for Presidio
  presidio-lb:
    image: nginx:alpine
    container_name: presidio-loadbalancer
    ports:
      - "7317:7317"
    volumes:
      - ./presidio-nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - presidio-1
      - presidio-2
      - presidio-3
      - presidio-4
    restart: unless-stopped
    networks:
      - firewall-net
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:7317/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  # Presidio Instance 1
  presidio-1:
    build: ./presidio_sidecar
    container_name: presidio-1
    environment:
      - PRESIDIO_WORKERS=2
      - PRESIDIO_LOG_LEVEL=warning
      - PRESIDIO_NER_ENGINE=xlmr
      - XLMR_NER_DEVICE=-1
      - XLMR_NER_MODEL=hrl
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 512M
          cpus: '0.5'
    restart: unless-stopped
    networks:
      - firewall-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7317/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Presidio Instance 2
  presidio-2:
    build: ./presidio_sidecar
    container_name: presidio-2
    environment:
      - PRESIDIO_WORKERS=2
      - PRESIDIO_LOG_LEVEL=warning
      - PRESIDIO_NER_ENGINE=xlmr
      - XLMR_NER_DEVICE=-1
      - XLMR_NER_MODEL=hrl
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 512M
          cpus: '0.5'
    restart: unless-stopped
    networks:
      - firewall-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7317/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Presidio Instance 3
  presidio-3:
    build: ./presidio_sidecar
    container_name: presidio-3
    environment:
      - PRESIDIO_WORKERS=2
      - PRESIDIO_LOG_LEVEL=warning
      - PRESIDIO_NER_ENGINE=xlmr
      - XLMR_NER_DEVICE=-1
      - XLMR_NER_MODEL=hrl
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 512M
          cpus: '0.5'
    restart: unless-stopped
    networks:
      - firewall-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7317/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Presidio Instance 4
  presidio-4:
    build: ./presidio_sidecar
    container_name: presidio-4
    environment:
      - PRESIDIO_WORKERS=2
      - PRESIDIO_LOG_LEVEL=warning
      - PRESIDIO_NER_ENGINE=xlmr
      - XLMR_NER_DEVICE=-1
      - XLMR_NER_MODEL=hrl
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 512M
          cpus: '0.5'
    restart: unless-stopped
    networks:
      - firewall-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7317/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

networks:
  firewall-net:
    driver: bridge
