version: "3.9"

x-go-base: &go-base
  image: golang:1.22
  working_dir: /workspace
  volumes:
    - ./:/workspace
  environment:
    GOCACHE: /workspace/.gocache
    GOMODCACHE: /workspace/.gomodcache

services:
  dev:
    <<: *go-base
    command: sleep infinity
  cli:
    <<: *go-base
    command: go run ./cmd/gateway
    environment:
      <<: *go-base.environment
      TOKEN_EXCHANGE_BASE_URL: ${TOKEN_EXCHANGE_BASE_URL:-http://host.docker.internal:8080}
      TOKLIGENCE_EMAIL: ${TOKLIGENCE_EMAIL:-dev@example.com}
      TOKLIGENCE_DISPLAY_NAME: ${TOKLIGENCE_DISPLAY_NAME:-Dev Gateway}
      TOKLIGENCE_ENABLE_PROVIDER: ${TOKLIGENCE_ENABLE_PROVIDER:-false}
      TOKLIGENCE_PUBLISH_NAME: ${TOKLIGENCE_PUBLISH_NAME:-}
      TOKLIGENCE_MODEL_FAMILY: ${TOKLIGENCE_MODEL_FAMILY:-}
    profiles:
      - runtime
  test:
    <<: *go-base
    command: go test ./...
    profiles:
      - test
