version: "3.9"

x-go-base: &go-base
  image: golang:1.22
  working_dir: /workspace
  volumes:
    - ./:/workspace
  environment:
    GOCACHE: /workspace/.gocache
    GOMODCACHE: /workspace/.gomodcache

services:
  dev:
    <<: *go-base
    command: sleep infinity
  cli:
    <<: *go-base
    command: go run ./cmd/gateway
    environment:
      <<: *go-base.environment
      TOKEN_EXCHANGE_BASE_URL: ${TOKEN_EXCHANGE_BASE_URL:-http://host.docker.internal:8080}
      GATEWAY_EMAIL: ${GATEWAY_EMAIL:-dev@example.com}
      GATEWAY_DISPLAY_NAME: ${GATEWAY_DISPLAY_NAME:-Dev Gateway}
      GATEWAY_ENABLE_PROVIDER: ${GATEWAY_ENABLE_PROVIDER:-false}
      GATEWAY_PUBLISH_NAME: ${GATEWAY_PUBLISH_NAME:-}
      GATEWAY_MODEL_FAMILY: ${GATEWAY_MODEL_FAMILY:-}
    profiles:
      - runtime
  test:
    <<: *go-base
    command: go test ./...
    profiles:
      - test
