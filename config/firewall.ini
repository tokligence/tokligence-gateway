# ==============================================================================
# Tokligence Gateway Prompt Firewall Configuration
# ==============================================================================
# The firewall protects against PII leakage and sensitive data exposure
# in both user prompts (input) and LLM responses (output).
#
# Configuration Hierarchy (priority from high to low):
# 1. Environment variables (e.g., TOKLIGENCE_PROMPT_FIREWALL_MODE, TOKLIGENCE_PROMPT_FIREWALL_ENABLED)
#    - Highest priority, overrides everything
# 2. This firewall.ini file
#    - Main firewall configuration
# 3. Default values in code
#    - Lowest priority, used when no override is specified
#
# Modes:
#   - disabled: Firewall completely disabled (default in code)
#   - redact:   Detect PII → Replace with tokens → Restore in responses (RECOMMENDED for production)
#   - monitor:  Log violations but allow requests through (for testing)
#   - enforce:  Block requests that violate policies (strict mode)
#
# Note: The default in code is "disabled". To enable firewall, uncomment this file
# and set mode to "redact" (recommended) or another mode.
#
# Environment variable overrides:
#   TOKLIGENCE_PROMPT_FIREWALL_MODE=redact|monitor|enforce|disabled
#   TOKLIGENCE_PROMPT_FIREWALL_ENABLED=true|false
#   TOKLIGENCE_PROMPT_FIREWALL_CONFIG=path/to/firewall.ini  (to use a different config file)
# ==============================================================================

[prompt_firewall]
enabled = true
mode = redact

# PII patterns configuration file
pii_patterns_file = config/pii_patterns.ini

# Enabled regions (comma-separated)
# Available: global, us, cn, eu, uk, ca, au, in, jp, de, fr, sg
# Leave empty to use defaults from pii_patterns.ini
pii_regions = global,us,cn

# Alternatively, specify exact PII types (comma-separated, overrides regions if set)
# Available types: EMAIL, PHONE, SSN, CREDIT_CARD, IP_ADDRESS, API_KEY, CRYPTO_ADDRESS,
#                  NATIONAL_ID, PASSPORT, DRIVERS_LICENSE, BANK_ACCOUNT, TAX_ID, MEDICAL_ID, etc.
# pii_types = EMAIL,PHONE,SSN,NATIONAL_ID,API_KEY

# ==============================================================================
# Presidio Sidecar Supported PII Types (when filter_presidio_enabled = true)
# ==============================================================================
# The Presidio sidecar provides enhanced PII detection including:
#
# Critical Severity (blocks request in enforce mode):
#   - CREDIT_CARD: Credit card numbers (all major types)
#   - US_SSN: US Social Security Numbers (xxx-xx-xxxx)
#   - PASSPORT: International passport numbers (22 countries - see below)
#   - CN_ID_CARD: Chinese national ID (18-digit 身份证)
#
# Medium Severity:
#   - EMAIL_ADDRESS: Email addresses
#   - PHONE_NUMBER: Phone numbers (US, UK, CN, SG, international)
#   - VEHICLE_PLATE: Vehicle license plates (China only)
#
# Low Severity:
#   - PERSON: Person names (English, Chinese with XLM-RoBERTa)
#   - LOCATION: Locations/addresses
#   - IP_ADDRESS: IP addresses (IPv4, IPv6)
#   - URL: Web URLs
#
# Passport Detection (22 countries):
#   Asia:        CN, JP, KR, IN, SG, MY, TH, PH
#   Europe:      UK, DE, FR, IT, ES, PL, RU
#   Americas:    US, CA, MX, BR
#   Oceania:     AU, NZ
#   Middle East: UAE, SA
#
# Note: US/UK/UAE passports require context keywords (e.g., "passport: 123456789")
#       to avoid false positives with other 9-digit numbers.
#
# Test passport detection: ./tests/firewall/test_passport_recognizer.sh
# ==============================================================================

# Minimum confidence threshold (0.0-1.0)
# Only detections above this threshold will trigger actions
pii_min_confidence = 0.75

# Log all firewall decisions (useful for debugging)
log_decisions = true

# Log PII values in debug mode (WARNING: disable in production for security)
log_pii_values = false

# Maximum PII entities in a single request (soft limit, logs warning if exceeded)
max_pii_entities = 50

# ==============================================================================
# SSE Streaming Configuration (for redact mode with streaming responses)
# ==============================================================================
# When streaming responses contain PII tokens (e.g., [PERSON_abc123]), they may
# be split across multiple SSE chunks. These settings control buffering behavior
# to ensure proper detokenization.

# Maximum time (ms) to wait for closing bracket before force flushing buffer.
# Note: SSE chunks have ~20-50ms delays, tokens take ~300-450ms to complete.
# Increase this if tokens are being prematurely flushed in slow networks.
# redact_sse_buffer_timeout_ms = 500

# Maximum characters to buffer while waiting for closing bracket.
# Normal PII tokens are ~20 chars (e.g., [PERSON_abc123]), 30 gives buffer.
# redact_sse_max_buffer_length = 30

# ==============================================================================
# PII Tokenizer Configuration (for redact mode)
# ==============================================================================
[tokenizer]
# Storage backend: memory | redis | redis_cluster
# - memory: Fast, single-instance, lost on restart (default for dev)
# - redis: Persistent, supports multiple gateway instances
# - redis_cluster: High availability, distributed
store_type = memory

# Time-to-live for token mappings (duration format: 1h, 30m, etc.)
ttl = 1h

# Redis configuration (only used if store_type = redis)
# redis_addr = localhost:6379
# redis_password =
# redis_db = 0
# redis_key_prefix = firewall:tokens

# Redis Cluster configuration (only used if store_type = redis_cluster)
# redis_cluster_addrs = redis-node1:7000,redis-node2:7001,redis-node3:7002
# redis_cluster_key_prefix = firewall:tokens

# ==============================================================================
# Input Filters (applied to user prompts before sending to LLM)
# ==============================================================================
[firewall_input_filters]
# Built-in PII regex filter (fast, no external dependencies)
filter_pii_regex_enabled = true
filter_pii_regex_priority = 10

# External Presidio service (optional, higher accuracy)
# Start Presidio sidecar with: make pii-start
# For best Chinese name detection, use XLM-RoBERTa mode:
#   cd examples/firewall/presidio_sidecar && PRESIDIO_NER_ENGINE=xlmr python main.py
filter_presidio_enabled = true
filter_presidio_priority = 20
filter_presidio_endpoint = http://localhost:7317/v1/filter/input
filter_presidio_timeout_ms = 5000
filter_presidio_on_error = allow

# ==============================================================================
# Output Filters (applied to LLM responses before returning to user)
# ==============================================================================
[firewall_output_filters]
# Built-in PII regex filter for detokenization
filter_pii_regex_enabled = true
filter_pii_regex_priority = 10

# Presidio output filter (for detecting PII in LLM responses)
# NOTE: Disabled in redact mode because Presidio re-redacts the output
# which conflicts with detokenization. Enable only in monitor/enforce modes.
filter_presidio_enabled = false
filter_presidio_priority = 20
filter_presidio_endpoint = http://localhost:7317/v1/filter/output
filter_presidio_timeout_ms = 5000
filter_presidio_on_error = allow
